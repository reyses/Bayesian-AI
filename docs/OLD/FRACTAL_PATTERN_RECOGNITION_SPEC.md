# Fractal Pattern Recognition Specification

## 1. Executive Summary

This document outlines the **Fractal Pattern Recognition** system integrated into the "Fractal Three-Body Quantum" engine. The core objective is to detect self-similar geometric structures across multiple timeframes (15s, 5m, 15m, 1h) and correlate them with high-probability trade outcomes using Bayesian inference.

By combining **Geometric Shape Detection** (Compression, Wedge, Breakdown) with **Quantum Field Mechanics** (Z-scores, Wave Function), the system achieves a robust signal generation mechanism that filters noise and identifies structural market shifts.

---

## 2. Geometric Patterns

The system currently detects three primary geometric patterns using vectorized rolling window logic:

### 2.1 Compression (The Coil)
**Logic:** A contraction in volatility where the recent price range is significantly smaller than the previous range.
-   **Algorithm:** `Range(Recent 5 Bars) < 0.7 * Range(Previous 5 Bars)`
-   **Significance:** Precedes explosive expansion. In Quantum terms, this represents a **Low Entropy** state with high potential energy (superposition).
-   **Signal:** "Prepare for breakout."

### 2.2 Wedge (The Squeeze)
**Logic:** Converging trendlines where highs are lower and lows are higher.
-   **Algorithm:** `Highs[i] < Highs[i-4]` AND `Lows[i] > Lows[i-4]` (over 5 bars)
-   **Significance:** Represents a conflict between buyers and sellers resolving towards a singularity.
-   **Signal:** "Directional bias forming."

### 2.3 Breakdown (The Collapse)
**Logic:** Price drops below a significant local support level.
-   **Algorithm:** `Low[i] < Min(Lows[i-4 : i])`
-   **Significance:** Failure of structure (L8). Confirming a transition from Stable (L1) to Roche Limit (L2/L3).
-   **Signal:** "Immediate entry trigger (if aligned with trend)."

---

## 3. Fractal Alignment (Multi-Timeframe Resonance)

The true power of the system lies in **Fractal Resonance**, where patterns align across timeframes.

### 3.1 The Time Slices
-   **Macro (1h / 4h):** Defines the **Context** (Trend Direction, Major Support/Resistance).
-   **Meso (15m):** Defines the **Structure** (Three-Body Gravity, Attractors).
-   **Micro (15s):** Defines the **Trigger** (Geometric Patterns, Velocity Cascades).

### 3.2 Resonance Logic
A high-probability trade setup occurs when:
1.  **Macro:** 4h Trend is UP.
2.  **Meso:** 15m Price is at Lower Singularity (L3 Roche Limit, -2 Sigma).
3.  **Micro:** 15s chart shows a **Wedge** followed by a **Breakout** (or localized Breakdown of resistance).

The `ThreeBodyQuantumState` captures this via:
-   `trend_direction_15m` (Meso context)
-   `lagrange_zone` (Meso location)
-   `pattern_type` (Micro trigger)

---

## 4. Bayesian Learning Integration

The `QuantumBayesianBrain` learns the probability of success for each pattern in each context.

### 4.1 State Definition
The state tuple includes:
```python
core = (
    z_bin,              # Where are we? (Roche Limit vs Center)
    momentum_bin,       # How fast are we moving?
    lagrange_zone,      # Stability classification
    structure_confirmed,# Volume + Maturity
    cascade_detected,   # Velocity spike
    trend_direction_15m,# Macro trend
    pattern_type        # Geometric shape (COMPRESSION, WEDGE, BREAKDOWN, NONE)
)
```

### 4.2 Learning Process
1.  **Observation:** The system records the state at entry.
2.  **Outcome:** The trade result (Win/Loss/Duration) is recorded.
3.  **Update:** The Bayesian table updates the posterior probability for `(State + Pattern)`.

**Example Learning:**
-   *Initial Belief:* "Wedge at L2 Roche Limit is neutral (50%)."
-   *Observation 1:* Wedge at L2 fails (Loss). -> Prob 45%.
-   *Observation 2:* Wedge at L2 fails (Loss). -> Prob 40%.
-   *Observation 3:* Compression at L2 succeeds (Win). -> Prob 55%.
-   *Result:* The brain learns to prefer **Compression** over **Wedge** at the L2 Roche Limit for this asset.

---

## 5. Future Roadmap

1.  **Dynamic Pattern Window:** Instead of fixed 5-bar windows, implement **Dynamic Time Warping** (DTW) to detect patterns of varying lengths.
2.  **Pattern Confluence:** Add a `confluence_score` metric that sums the strength of patterns across 1m, 5m, and 15m simultaneously.
3.  **Visual Debugging:** Enhance `dashboard.ipynb` to overlay detected patterns on price charts.

---

**Generated by Jules (AI Architect) - 2026-02-17**
